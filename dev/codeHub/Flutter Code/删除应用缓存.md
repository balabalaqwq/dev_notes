# Flutter 删除应用缓存



iOS未测试

```
import 'dart:io';

import 'package:bgi_online_moniter/base/Constant.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:path_provider/path_provider.dart';
import 'package:toast/toast.dart';

///删除应用缓存
class CacheUtil {

  static String _cacheSizeStr;
  static Directory tempDir;//应用缓存目录
  static Directory webViewCacheDir;//特定目录：例如webview缓存
  static cacheSetting(BuildContext context) async {
    await loadCache();
    showCupertinoDialog(
      context: context,
      builder: (_) => CupertinoAlertDialog(
        content: Container(
          height: 150,
          child: Center(
            child: Text(
              "发现$_cacheSizeStr缓存文件, 是否清除？",
              strutStyle:
              StrutStyle(forceStrutHeight: true, height: 1, leading: 1),
              style: TextStyle(
                fontSize: 18,
              ),
            ),
          ),
        ),
        actions: <Widget>[
          CupertinoButton(
            child: Text(
              "取消",
              style: TextStyle(color: Colors.grey),
            ),
            onPressed: () {
              Navigator.pop(context);
            },
          ),
          CupertinoButton(
            child: Text("确定"),
            onPressed: () {
              _clearCache(context);
              Navigator.pop(context);
            },
          ),
        ],
      ),
    );
  }

  ///加载缓存
  static Future loadCache() async {
    try {
      tempDir = await getTemporaryDirectory();
      webViewCacheDir = Directory("/storage/emulated/0/flutterWebView");
      double value = ((await _getTotalSizeOfFilesInDir(tempDir))??0) + ((await _getTotalSizeOfFilesInDir(webViewCacheDir))??0);

//打印每个缓存文件的路径
      tempDir.list(followLinks: false, recursive: true).listen((file) {
        print(file.path);
      });
      webViewCacheDir.list(followLinks: false, recursive: true).listen((file) {
        print(file.path);
      });

      print('临时目录大小: ' + value.toString());
      _cacheSizeStr = _renderSize(value);
    } catch (e) {
      print(e);
    }
  }

  ///计算文件大小
  static Future<double> _getTotalSizeOfFilesInDir(final FileSystemEntity file) async {
    try {
      if (file is File) {
        int length = await file.length();
        return double.parse(length.toString());
      }
      if (file is Directory) {
        final List<FileSystemEntity> children = file.listSync();
        double total = 0;
        if (children != null)
          for (final FileSystemEntity child in children)
            total += await _getTotalSizeOfFilesInDir(child);
        return total;
      }
      return 0;
    } catch (e) {
      print(e);
    }
  }

  ///格式化文件大小
   static _renderSize(double value) {
    try {
      if (null == value) {
        return '0.0B';
      }
      List<String> unitArr = List()..add('B')..add('K')..add('M')..add('G');
      int index = 0;
      while (value > 1024) {
        index++;
        value = value / 1024;
      }
      String size = value.toStringAsFixed(2);
      return size + unitArr[index];
    } catch (e) {
      print(e);
    }
  }

  static void _clearCache(BuildContext context) async {
    try {
//删除缓存目录
      await delDir(tempDir);
      await delDir(webViewCacheDir);
      await loadCache();
      // _cacheSizeStr = '0.0B';
      Toast.show('清除缓存成功', context);
    } catch (e) {
      print(e);
    }
  }

  ///直接删除子目录和文件即可
  static Future<Null> delDir(FileSystemEntity file) async {
    try {
      if (file is Directory) {
        final List<FileSystemEntity> children = file.listSync();
        for (final FileSystemEntity child in children) {
          await delDir(child);
        }
      }
      await file.delete();
    } catch (e) {
      print(e);
    }
  }
}

```